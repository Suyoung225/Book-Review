## 45. 스트림은 주의해서 사용하라

### 스트림(Stream)이란?
> 스트림API는 다량의 데이터 처리 작업을 돕고자 자바 8에 추가되었다. 스트림은 데이터 소스를 추상화하고, 데이터를 다루는데 자주 사용되는 메서드들을 정의해 놓았다. 즉, 데이터 소스와 상관없이 같은 방식으로 다루게 되어 코드의 재사용성이 높아졌다.

### 스트림은 데이터 소스를 변경하지 않는다.

```java
String[] strings = {"the", "glory", "part", "two"};
Arrays.stream(strings).sorted().forEach(System.out::println);
System.out.println(Arrays.toString(strings));
List<String> sortedList = Arrays.stream(strings).sorted().collect(Collectors.toList());
System.out.println(sortedList);
```
출력값:
>glory <br>
part <br>
the <br>
two <br>
[the, glory, part, two] <br>
[glory, part, the, two] <br>

### 스트림은 일회용이다.
Iterator로 컬렉션의 요소를 모두 읽고 나면 다시 사용할 수 없는 것처럼, 스트림도 한 번 사용하면 닫혀서 다시 사용할 수 없다.

### 스트림은 작업을 내부 반복으로 처리한다.
내부 반복이란 반복문을 메서드 내부에 숨길 수 있다는 것을 의미한다. <br>

### 스트림의 연산
스트림은 소스 스트림에서 시작해 최종 연산으로 끝나며, 그 사이에 하나 이상의 중간 연산이 있을 수 있다. <br>
중간 연산은 스트림을 어떠한 방식으로 변환(transform)한다. 연산 결과가 스트림이며, 스트림에 연속해서 중간 연산을 할 수 있다. 대표적으로 
filter(), map(), distinct(), limit(), sorted() 등이 있다. <br>
최종 연산은 중간 연산이 내놓은 스트림에 최후의 연산을 한다. 스트림의 모든 요소를 소모하면서 연산을 수행하므로 단 한번만 연산이 가능하며 연산 결과는 스트림이 아니다. forEach(), count(), max(), toArray(), reduce(), collect() 등이 있다. <br>

### 지연된 연산 (Lazy Evalution)
불필요한 연산을 위해 연산을 지연시킨다는 뜻이다. <br>
스트림 연산은 지연된 연산으로 최종 연산이 수행되기 전까지는 연산이 수행되지 않는다. 따라서 결과를 얻기 위해 필요하지 않은 연산은 수행되지 않게 된다.

```java
String[] strings = {"the", "glory", "part", "two"};
System.out.println(Arrays.stream(strings)
    .filter(i -> i.contains("o"))
    .map(String::toUpperCase)
    .findFirst().get()
);
```
출력값: 
> GLORY <br>

위 코드의 동작 방식은 아래와 같다. 즉 모든 요소에 연산을 수행하지 않고 필요한 첫 번째 요소만 찾으면 그 뒤의 불필요한 연산을 하지 않는다.
```java
System.out.println(Arrays.stream(strings)
    .filter(i -> {
        System.out.println("contains o");
        return i.contains("o");
        })
    .map(i -> {
        System.out.println("to UpperCase");
        return i.toUpperCase();
    })
    .findFirst().get()
);
```
출력값:
> contains o <br>
contains o <br>
to UpperCase <br>
GLORY <br>

### 병렬 처리
스트림은 기본적으로 순차적으로 수행되지만 parallel() 메서드를 호출하여 병렬로 연산을 수행하도록 할 수 있다. <br>
하지만 병렬 처리가 항상 빠른 성능을 보장하는 것이 아니고 스트림을 잘못 병렬화하면 프로그램 오작동을 유발하거나 성능을 오히려 악화시킬 수 있으므로 주의해서 사용해야 한다. (Item.48) 


***

## 스트림 사용 노하우

### 예제 - 사전을 훑어 원소 수가 많은 아나그램 그룹들을 출력

```java
import java.io.File;
import java.io.IOException;
import java.util.*;

public class EffectiveJava {
    public static void main(String[] args) throws IOException {
        File dictionary = new File(args[0]);
        int minGroupSize = Integer.parseInt(args[1]);

        Map<String, Set<String>> groups = new HashMap<>();
        try (Scanner s = new Scanner(dictionary)) {
            while (s.hasNext()) {
                String word = s.next();
                groups.computeIfAbsent(alphabetize(word),
                        (unused) -> new TreeSet<>()).add(word);
            }
        }

        for (Set<String> group : groups.values())
            if (group.size() >= minGroupSize)
                System.out.println(group.size() + ": " + group);
    }

    private static String alphabetize(String s) {
        char[] a = s.toCharArray();
        Arrays.sort(a);
        return new String(a);
    }
}

```
출력값:
> 3: [avaj, java, vjaa] <br>
2: [cpp, pcp]

<details>
<summary><strong> 예제 실행 방법 </strong></summary>
<div markdown="1">       

1. dict.txt 파일 생성  <br>
2. 아래 내용을 위 텍스트 파일에 저장 <br>
java <br>
cpp <br>
python  <br>
avaj <br>
vjaa <br>
pcp <br>
letsgo <br>
3. IntelliJ 사용 - Modify Run Configuration - Program arguments 에 dict.txt 2 입력 <br>
커맨드(cmd) 사용- 현재 디렉토리로 변경- 
javac 클래스명.java <br>
java 클래스명 dict.txt 2 <br>

</div>
</details>
</br>

***

### 참고 자료

Java의 정석 3rd Edition - 남궁성 <br>
스트림 정리 -
https://futurecreator.github.io/2018/08/26/java-8-streams/ <br>
Lazy Evaluation - https://dororongju.tistory.com/137
<br>
병렬 처리 - https://ict-nroo.tistory.com/43 <br>
